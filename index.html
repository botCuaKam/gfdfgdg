<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Offline Zone Search</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f9;
    padding: 20px;
}

h1 {
    text-align: center;
}

input, button {
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
    width: 100%;
}

button {
    cursor: pointer;
    background: #007bff;
    color: white;
    border: none;
}

.card {
    background: white;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.score {
    font-size: 12px;
    color: gray;
}

.highlight {
    background: yellow;
}
</style>
</head>
<body>

<h1>Smart Offline Zone Search</h1>

<input type="file" id="IMG_1770222327405_1772211543197.jpg" accept="image/*">
<div id="status"></div>

<input type="text" id="searchInput" placeholder="Nhập câu hỏi: Ai phụ trách 161? Zone nào có Ngọc Hồi?">

<div id="results"></div>

<script>

let lines = [];

const imageInput = document.getElementById("IMG_1770222327405_1772211543197.jpg");
const searchInput = document.getElementById("searchInput");
const results = document.getElementById("results");
const status = document.getElementById("status");

// ===== OCR =====
imageInput.addEventListener("change", async function() {
    const file = this.files[0];
    if (!file) return;

    status.innerText = "Đang đọc ảnh...";
    results.innerHTML = "";
    lines = [];

    const { data: { text } } = await Tesseract.recognize(
        file,
        'vie+eng'
    );

    lines = text.split("\n").filter(l => l.trim() !== "");
    status.innerText = "Đã đọc xong ảnh. Có thể tìm kiếm.";
});

// ===== SEARCH =====
searchInput.addEventListener("input", function() {
    const query = this.value.toLowerCase().trim();
    results.innerHTML = "";

    if (!query) return;

    const tokens = extractTokens(query);

    const scored = lines.map(line => {
        const score = calculateScore(line.toLowerCase(), tokens);
        return { line, score };
    });

    const filtered = scored
        .filter(item => item.score > 0)
        .sort((a,b) => b.score - a.score)
        .slice(0, 10);

    filtered.forEach(item => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = highlight(item.line, tokens.join("|")) +
                        `<div class="score">Score: ${item.score}</div>`;
        results.appendChild(div);
    });
});

// ===== TOKEN EXTRACTION =====
function extractTokens(text) {
    let numbers = text.match(/\d+/g) || [];
    let words = text.replace(/[^\w\s]/gi, '')
                    .split(/\s+/)
                    .filter(w => w.length > 2);

    return [...new Set([...numbers, ...words])];
}

// ===== SCORING =====
function calculateScore(line, tokens) {
    let score = 0;

    tokens.forEach(token => {
        if (line.includes(token)) score += 3;
        else if (similarity(line, token) > 0.6) score += 1;
    });

    return score;
}

// ===== SIMILARITY =====
function similarity(a, b) {
    let longer = a.length > b.length ? a : b;
    let shorter = a.length > b.length ? b : a;

    if (longer.length === 0) return 1.0;
    return (longer.length - editDistance(longer, shorter)) / longer.length;
}

function editDistance(a, b) {
    const matrix = [];

    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i - 1) === a.charAt(j - 1))
                matrix[i][j] = matrix[i - 1][j - 1];
            else
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
        }
    }

    return matrix[b.length][a.length];
}

// ===== HIGHLIGHT =====
function highlight(text, pattern) {
    const regex = new RegExp(`(${pattern})`, "gi");
    return text.replace(regex, '<span class="highlight">$1</span>');
}

</script>

</body>
</html>
